<%- include("../header") %> 
<%- include("../components/navbar") %>
<%- include("../components/flash_msg") %>

<h2>Project Detail Page</h2>
<% items.forEach(item => { %>
    <ul class="list-group item-list">
        <li class="list-group-item">
            <div class="row">
                <div class="col">
                    <div class="item-details">
                        <h3 class="item-name"><%= item.name %></h3>
                        <p class="item-description"><%= item.description %></p>
                        <p class="item-author">Author: <%= item.author %></p>
                    </div>
                </div>
                <div class="col-3">
                    <p class="item-date">Created At: <%= item.displayCreatedAt() %></p>
                    <p class="item-date">Updated At: <%= item.displayUpdatedAt() %></p>
                </div>
            </div>
        </li>
    </ul>
<% }); %>

<br>
<h2>Tasks</h2>

<!-- add new task of this project -->
<h3>Add Task</h3>


<style>
.task-input-width {
    width: 90%;
}

</style>

<form action="/tasks/add" method="post" class="col">
        <input name="project_id" type="hidden" value="<%= items[0].getId() %>">
        <input placeholder="Title" class="form-control task-input-width my-1" name="name" type="text" >
        <textarea rows="3" placeholder="Description" class="form-control task-input-width my-1" name="description"></textarea>
        <button class="btn btn-primary" type="submit">Add Task</button>
</form>

<br>

<style>

    .task-item-closed .task-name{
        text-decoration: line-through;

    }
</style>

<ul class="list-group task-list">
    <% childItems.forEach(task => { %>
        <li class="list-group-item task-item <%= task.is_closed ? "task-item-closed" : "" %> ">
            <div class="row">
                <div class="col-md-7">
                    <div class="task-details">
                        <h3 class="task-name"><%= task.name %></h3>
                        <p class="task-author">Author: <%= task.author %></p>
                    </div>
                </div>
                <div class="col-md-3">
                    <p class="task-date">Created At: <%= task.displayCreatedAt() %></p>
                    <p class="task-date">Updated At: <%= task.displayUpdatedAt() %></p>
                </div>
                <div hidden class="show-value-is-closed"><%= task.is_closed %></div>
                <div class="row">
                    <button class="btn btn-outline-primary" onclick="changeTaskClosedState(this, <%= task.id %>)">Change State</button>
                    <button class="btn btn-outline-success" onclick="getAllTasksWithParentProject(this, <%= task.id %>)">Show Results</button>
                </div>
            </div>
        </li>
    <% }); %>
</ul>


<br>
<br>
<br>

<script type="text/javascript" src="/js/common.js"></script>
<script type="text/javascript" src="/js/detail_api.js"></script>

<script>
async function changeTaskClosedState(button, taskId) {
    const closedText = "1"
    const notClosedText = "0"

    try {

        const taskItem = button.closest('.task-item')
        const showValue = taskItem.querySelector('.show-value-is-closed');
        const currentStateClosed = String(showValue.textContent)
        console.log()

        await changeTaskCloseStateApi(taskId, currentStateClosed) ;

        if (currentStateClosed === notClosedText) {
            taskItem.classList.add("task-item-closed");
            showValue.textContent  = closedText;
        } else {
            taskItem.classList.remove("task-item-closed");
            showValue.textContent  = notClosedText;
        }

    } catch (err) {
        console.error(err)
    }
};

async function getAllTasksWithParentProject(button, taskId) {

    // remove already exist items
    const taskListOfResult = button.closest('.task-item').querySelectorAll('.list-group-item'); // : Node[]

    if (taskListOfResult.length > 0) {
        taskListOfResult.forEach(item => {
            item.remove()
        })
        return
    }

    const tasks = await getAllTasksWithParentProjectIdApi(taskId)

    // no item
    if (!tasks.length) {
        const noItem = document.createElement('li');
        noItem.classList.add('list-group-item');
        noItem.textContent = "no item"

        button.closest('.task-item').appendChild(noItem);
    }

    // default
    tasks.forEach(task => {
        const listItem = document.createElement('li');
        listItem.classList.add('list-group-item');
        listItem.textContent = task.name;

        button.closest('.task-item').appendChild(listItem);
    });
}

</script>

<%- include("../footer") %>
